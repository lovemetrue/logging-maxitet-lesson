# Добавление Logstash в docker-compose.yml
cat << EOF >> docker-compose.yml
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    ports:
      - "5044:5044"
      - "5000:5000/tcp"
      - "5000:5000/udp"
      - "9600:9600"
    environment:
      - XPACK_MONITORING_ENABLED=false
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
      - ./logs:/var/log/app
    depends_on:
      - elasticsearch
EOF

# Создание конфигурации Logstash
mkdir -p logs
cat << EOF > logstash.conf
input {
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Парсинг JSON логов
  if [message] =~ /^{.*}$/ {
    json {
      source => "message"
    }
  }
  
  # Парсинг обычных текстовых логов
  else {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:message_text}" 
      }
    }
    
    # Парсинг timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }
  
  # Для отладки - вывод в консоль
  stdout { 
    codec => rubydebug 
  }
}
EOF

# Создание тестовых логов
cat << EOF > logs/app.log
2024-01-15T10:30:00Z INFO User john_doe logged in successfully
2024-01-15T10:31:15Z ERROR Database connection failed: connection refused
{"timestamp":"2024-01-15T10:32:00Z","level":"WARN","message":"High memory usage detected","service":"api-server"}
EOF

# Перезапуск сервисов
docker-compose down
docker-compose up -d
